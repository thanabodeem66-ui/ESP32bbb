<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Web BLE</title>
  <meta charset="UTF-8">

  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- TOP BAR -->
<div class="topnav">
  <h1>ESP32 Web BLE Application</h1>
</div>


<div class="content">

<!-- CONNECT -->
<div class="card-grid">
<div class="card">

<button id="connect" class="connectButton">
Connect to BLE Device
</button>

<button id="disconnect" class="disconnectButton">
Disconnect BLE Device
</button>

<p class="gray-label">
BLE state:
<strong>
<span id="state" style="color:red;">Disconnected</span>
</strong>
</p>

</div>
</div>


<!-- DATA -->
<div class="card-grid">

<!-- HR -->
<div class="card">
<h2>â¤ï¸ Heart Rate</h2>
<p class="reading">
<span id="hr">--</span> bpm
</p>
</div>

<!-- SpO2 -->
<div class="card">
<h2>ğŸ« SpOâ‚‚</h2>
<p class="reading">
<span id="spo2">--</span> %
</p>
</div>

<!-- Temp -->
<div class="card">
<h2>ğŸŒ¡ Temperature</h2>
<p class="reading">
<span id="tempC">--</span> Â°C
</p>
<p class="gray-label">
(<span id="tempF">--</span> Â°F)
</p>
</div>

</div>


<!-- LED -->
<div class="card-grid">

<div class="card">
<h2>ğŸ’¡ LED</h2>

<button class="ledOn" onclick="ledOn()">ON</button>
<button class="ledOff" onclick="ledOff()">OFF</button>

</div>

</div>

</div>


<!-- JS -->
<script>

const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
const dataUUID    = "19b10002-e8f2-537e-4f6c-d104768a1214";
const ledUUID     = "19b10001-e8f2-537e-4f6c-d104768a1214";

let bleServer;
let dataChar;
let ledChar;


// CONNECT
document.getElementById("connect").onclick = async () => {

const device = await navigator.bluetooth.requestDevice({
filters: [{ name: "ESP32bbb" }],
optionalServices: [serviceUUID]
});

const server = await device.gatt.connect();
bleServer = server;

document.getElementById("state").innerText = "Connected";
document.getElementById("state").style.color = "green";

const service = await server.getPrimaryService(serviceUUID);

dataChar = await service.getCharacteristic(dataUUID);
ledChar  = await service.getCharacteristic(ledUUID);

await dataChar.startNotifications();

dataChar.oncharacteristicvaluechanged = handleData;

};


// DISCONNECT
document.getElementById("disconnect").onclick = () => {

if(bleServer){
bleServer.disconnect();
}

document.getElementById("state").innerText = "Disconnected";
document.getElementById("state").style.color = "red";
};


// RECEIVE DATA
function handleData(event){

let text = new TextDecoder().decode(event.target.value);

console.log(text);

let arr = text.split(",");

if(arr.length < 4) return;

let hr    = arr[0];
let spo2  = arr[1];
let tempC = arr[2];
let tempF = arr[3];

document.getElementById("hr").innerText = hr;
document.getElementById("spo2").innerText = spo2;
document.getElementById("tempC").innerText = tempC;
document.getElementById("tempF").innerText = tempF;

}


// LED ON
async function ledOn(){

if(!ledChar) return;

await ledChar.writeValue(
Uint8Array.of(1)
);

}


// LED OFF
async function ledOff(){

if(!ledChar) return;

await ledChar.writeValue(
Uint8Array.of(0)
);

}

</script>

</body>
</html>
