<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Health Monitor</title>
  <meta charset="UTF-8">

  <style>
    body{
      font-family: Arial;
      text-align:center;
      background:#f2f2f2;
    }

    h1{
      background:#0A1128;
      color:white;
      padding:15px;
    }

    .card{
      background:white;
      padding:20px;
      margin:15px auto;
      width:300px;
      border-radius:10px;
      box-shadow:2px 2px 10px rgba(0,0,0,.2);
    }

    button{
      padding:10px 20px;
      border:none;
      border-radius:6px;
      color:white;
      cursor:pointer;
      margin:5px;
    }

    .connect{background:#28a745;}
    .disconnect{background:#dc3545;}

    .reading{
      font-size:2rem;
      font-weight:bold;
    }
  </style>
</head>

<body>

<h1>ESP32 Health Monitor</h1>

<div class="card">

  <button class="connect" id="connect">Connect</button>
  <button class="disconnect" id="disconnect">Disconnect</button>

  <p>Status:
    <b><span id="state" style="color:red">Disconnected</span></b>
  </p>

</div>


<div class="card">
  ‚ù§Ô∏è HR
  <div class="reading">
    <span id="hr">--</span> bpm
  </div>
</div>

<div class="card">
  ü´Å SpO‚ÇÇ
  <div class="reading">
    <span id="spo2">--</span> %
  </div>
</div>

<div class="card">
  üå° Temperature
  <div class="reading">
    <span id="tempC">--</span> ¬∞C
  </div>
  (<span id="tempF">--</span> ¬∞F)
</div>


<script>

/* ===== UUID ===== */
const serviceUUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
const dataUUID    = "19b10001-e8f2-537e-4f6c-d104768a1214";

let server;
let dataChar;

/* ===== CONNECT ===== */
document.getElementById("connect").onclick = async ()=>{

  try{

    const device = await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32bbb"}],
      optionalServices:[serviceUUID]
    });

    server = await device.gatt.connect();

    document.getElementById("state").innerText="Connected";
    document.getElementById("state").style.color="green";

    const service = await server.getPrimaryService(serviceUUID);

    dataChar = await service.getCharacteristic(dataUUID);

    await dataChar.startNotifications();

    dataChar.oncharacteristicvaluechanged = handleData;

  }catch(e){
    alert("Connect error");
    console.log(e);
  }
};

/* ===== DISCONNECT ===== */
document.getElementById("disconnect").onclick = ()=>{

  if(server) server.disconnect();

  document.getElementById("state").innerText="Disconnected";
  document.getElementById("state").style.color="red";
};


/* ===== RECEIVE ===== */
function handleData(e){

  let text = new TextDecoder().decode(e.target.value);

  console.log(text);

  let arr = text.split(",");

  if(arr.length<4) return;

  let hr    = arr[0];
  let spo2  = arr[1];
  let tempC = arr[2];
  let tempF = arr[3];

  // HR / SPO2
  if(hr=="0"||spo2=="0"){
    document.getElementById("hr").innerText="--";
    document.getElementById("spo2").innerText="--";
  }else{
    document.getElementById("hr").innerText=hr;
    document.getElementById("spo2").innerText=spo2;
  }

  // TEMP
  if(tempC=="-999"){
    document.getElementById("tempC").innerText="--";
    document.getElementById("tempF").innerText="--";
  }else{
    document.getElementById("tempC").innerText=tempC;
    document.getElementById("tempF").innerText=tempF;
  }
}

</script>

</body>
</html>
